/**
 * @license
 * (c) Copyright 2017-2018 Koopid Inc.
 * All rights reserved.
 */
function KoopidWidget(){if(this.ts=null,this._params=null,this._pending_post=[],"complete"==document.readyState||document.body)this.onload();else{var this_=this,handler=function(){window.removeEventListener("load",handler),this_.onload()};window.addEventListener("load",handler)}}function kpdw_callit(){var args=Array.prototype.slice.call(arguments,0),value=args.shift();value&&"[object Function]"=={}.toString.call(value)?value.apply(null,args):value&&void 0!==window[value]&&window[value].apply(null,args)}KoopidWidget.prototype.ajax=function(method,url,data,success_callback,error_callback,options){var response_type,request_type,headers,timeout,nocredentials;if(options&&(void 0!==options.response_type&&(response_type=options.response_type),void 0!==options.request_type&&(request_type=options.request_type),void 0!==options.headers&&(headers=options.headers),void 0!==options.timeout&&(timeout=options.timeout),!1===options.withCredentials&&(nocredentials=!0),!0===options.delegate))return this._ajaxDelegated(method,url,data,success_callback,error_callback);void 0===timeout&&(timeout=1e4);var request=new XMLHttpRequest;if(void 0!==success_callback||void 0!==error_callback){var timer=null;timeout&&timeout>0&&(timer=setTimeout(function(){4!=request.readyState&&(request.abort(),kpdw_callit(error_callback,"408 Request Timeout"))},timeout)),request.onreadystatechange=function(){if(4==request.readyState)if(null!=timer&&(clearTimeout(timer),timer=null),request.status>=200&&request.status<300){if(void 0!==response_type)return console.log("koopid-widget.js: ajax - response received"),void kpdw_callit(success_callback,request.response);console.log("ajax - response "+(request.responseText&&request.responseText.substr(0,100)));var response={};try{request.responseText&&(response=JSON.parse(request.responseText))}catch(e){return console.log("koopid-widget.js: ajax - error parsing response as JSON: "+e+"\nresponseText="+request.responseText),void kpdw_callit(error_callback,"failed to parse response")}response.error?kpdw_callit(error_callback,response.error.info||"received error"):kpdw_callit(success_callback,response)}else{var status="N/A",statusText="N/A";try{status=request.status}catch(e){}try{statusText=request.statusText}catch(e){}if(0==status&&!statusText){var hostname=url.match(/^https?:\/\/([^\/]+)/im);status="",statusText="failed "+(hostname&&hostname[1]||url)}kpdw_callit(error_callback,status+" "+statusText)}}}if(response_type&&("xml"==response_type?(request.response_type="document",request.overrideMimeType("text/xml")):request.responseType=response_type),request.open(method,url,!0),nocredentials||(request.withCredentials=!0),response_type&&"json"==response_type&&request.setRequestHeader("Accept","application/json"),headers&&headers.length>0&&headers.length%2==0)for(var i=0;i<headers.length;i+=2)request.setRequestHeader(headers[i],headers[i+1]);return data?request_type&&"application/json"!=request_type?"ignore"!=request_type&&request.setRequestHeader("Content-Type",request_type):(request.setRequestHeader("Content-Type","application/json"),data=JSON.stringify(data),console.log("koopid-widget.js: ajax - request "+url.substr(0,100)+"\n"+data.substr(0,100))):console.log("koopid-widget.js: ajax - request "+url.substr(0,100)),request.send("GET"==method?null:data||""),request},KoopidWidget.prototype._ajaxDelegated=function(method,path,data,success_callback,error_callback){var id=(""+Math.random()).substr(2,10),entry={type:"ajax",id:id,method:method,path:path,data:data};this.postRequest(JSON.stringify(entry),function(value){if(value){var data=JSON.parse(value);console.log("koopid-widget.js: received from container app "+JSON.stringify(data)),"ajax"==data.type&&data.id==id&&data.status?"success"==data.status?kpdw_callit(success_callback,data.data):kpdw_callit(error_callback,data.data):(console.log("koopid-widget.js: ignoring as invalid response"),kpdw_callit(error_callback,"invalid response"))}else kpdw_callit(error_callback,"not in an iframe")})},KoopidWidget.prototype.extractParams=function(url){if(void 0===url&&null!==this._params)return this._params;var r={},empty=!1;if(void 0===url&&(url=window.location.href,empty=!0),null===url)return r;var paramlist=url.split("?");if(2!=paramlist.length)return r;for(var params=(paramlist=paramlist[1].split("#")[0]).split("&"),i=0;i<params.length;i++){var p=params[i].split("=");1==p.length?r[p[0]]="":2==p.length&&(r[p[0]]=p[1])}return empty&&(this._params=r),r},KoopidWidget.prototype.getParam=function(name){var p=this.extractParams();return void 0!==p[name]?unescape(p[name].replace(/\+/g," ")):null},KoopidWidget.prototype.getCustomerId=function(){return console.log("WARN: kpdw.getCustomerId is deprecated, use kpdw.getProfile(..., 'context');"),this.getParam("cusid")},KoopidWidget.prototype.getName=function(){return console.log("WARN: kpdw.getName is deprecated."),this.getParam("name")},KoopidWidget.prototype.getContext=function(){return console.log("WARN: kpdw.getContext is deprecated, use kpdw.getProfile(..., 'context');"),this.getParam("context")},KoopidWidget.prototype.getWidgetInfo=function(){var w=this.getParam("state");if(w)try{return JSON.parse(w)}catch(ex){console.error(ex)}return null},KoopidWidget.prototype.applyZoom=function(minwidth,minheight){if(minwidth&&minheight){if(window.innerWidth<minwidth||window.innerHeight<minheight){var ratio=Math.min(window.innerWidth/minwidth,window.innerHeight/minheight);document.body.style.zoom=""+ratio}}else{var zoom=this.getParam("zoom");zoom&&(document.body.style.zoom=zoom)}},KoopidWidget.prototype._extractPath=function(){var p=window.location.pathname+window.location.search,n=p.indexOf("/kpd-static");return 0==n?p.substr("/kpd-static".length):0==(n=p.indexOf("/static"))?p.substr("/static".length):p},KoopidWidget.prototype.doAction=function(action){window.parent.postMessage(JSON.stringify({type:"action",action:action}),"*")},KoopidWidget.prototype.sendProgress=function(msg){msg&&this.doAction({invoke:"send",args:[{type:"progress",text:""+msg}]})},KoopidWidget.prototype.setPending=function(state){window.parent.postMessage(JSON.stringify({type:"setpending",value:state}),"*")},KoopidWidget.prototype.doClose=function(msg,state,noclosemessage){state&&"object"==typeof state?(msg||(msg="Widget is closed"),state.src=this._extractPath(),this.doAction({invoke:"send",args:[{type:"info",text:""+msg,widgetInfo:state,ts:this.ts||void 0}]})):msg&&this.doAction({invoke:"send",args:[{type:"info",text:""+msg,ts:this.ts||void 0}]}),noclosemessage||this.doAction({invoke:"send",args:[{type:"hidden",text:"widgetclose"}]}),window.parent.postMessage(JSON.stringify({type:"close"}),"*")},KoopidWidget.prototype.print=function(){"undefined"!=typeof pr?pr():window.print()},KoopidWidget.prototype.postRequest=function(request,callback){if(this._pending_post.length>0)return console.log("koopid-widget.js: putting the request in pending posts"),void this._pending_post.push([request,callback]);if(window.parent==window)return console.log("koopid-widget.js: cannot fetch unless in the client app iframe"),void kpdw_callit(callback);var this_=this,handler=function(event){if(event.source==window.parent){var item=this_._pending_post.shift();if(item){var callback=item[1];this_._pending_post.length>0?(console.log("koopid-widget.js: serving next request from pending posts"),window.parent.postMessage(this_._pending_post[0][0],"*")):window.removeEventListener("message",handler),kpdw_callit(callback,event.data)}}else console.log("koopid-widget.js: ignoring as source is not parent")};this._pending_post.push([request,callback]),window.addEventListener("message",handler),window.parent.postMessage(request,"*")},KoopidWidget.prototype.getProfile=function(callback,target,value){target||(target="local");var entry={type:"getprofile",target:target};value&&""!=value&&(entry.value=value),this.postRequest(JSON.stringify(entry),function(value){if(value){var data=JSON.parse(value);"setprofile"==data.type&&(console.log("koopid-widget.js: received from container app "+JSON.stringify(data.value)),kpdw_callit(callback,data.value))}})},KoopidWidget.prototype.sendSMS=function(phone,body,success_callback,error_callback){this.sendSMSEx(phone,body,0,success_callback,error_callback)},KoopidWidget.prototype.sendSMSEx=function(phone,body,provider,success_callback,error_callback){var entity={to:phone,body:body,providerid:""+provider||"0"};this.ajax("POST","/SMS",entity,function(response){console.log("koopid-widget.js: sendSMS success"),kpdw_callit(success_callback,response)},function(error){console.log("koopid-widget.js: sendSMS error - "+error),kpdw_callit(error_callback,error)},{delegate:!0})},KoopidWidget.prototype.sendEmail=function(subject,body,recipient,success_callback,error_callback){var this_=this;this.ajax("GET","/kpd-static/providers/0/templates/email.html",null,function(template){this_.ts=(new Date).getTime();var entity={from:"support@koopid.io",subject:subject};entity.body=template.replace(/%%%MESSAGE%%%/,body).replace(/%%%CONTEXT%%%/,this_.getContext()),recipient?entity.to=recipient:entity.to_userid=this_.getCustomerId(),this_.ajax("POST","/Email",entity,function(response){console.log("koopid-widget.js: sendEmail success"),kpdw_callit(success_callback,response)},function(error){console.log("koopid-widget.js: sendEmail error - "+error),kpdw_callit(error_callback,error)},{delegate:!0})},function(error){console.log("koopid-widget.js: sendEmail template error - "+error),kpdw_callit(error_callback,"cannot get email template - "+error)},{response_type:"html"})},KoopidWidget.prototype.fingerprint=function(request,success_callback,error_callback){this.postRequest(JSON.stringify({type:"fingerprint",request:request}),function(value){if(value){var data=JSON.parse(value);"fingerprint"==data.type&&(console.log("koopid-widget.js: received from container app "+data.response),data.response?kpdw_callit(success_callback):kpdw_callit(error_callback,data.reason||"failed"))}else kpdw_callit(error_callback,"not in the client app iframe")})},KoopidWidget.prototype.getclipboard=function(success_callback){this.postRequest(JSON.stringify({type:"getclipboard"}),function(value){if(value){var data=JSON.parse(value);"setclipboard"==data.type&&(console.log("koopid-widget.js: received from container app "+JSON.stringify(data)),kpdw_callit(success_callback,data.value||""))}})},KoopidWidget.prototype.showWidgetInfo=function(){for(var text=null,node=document.firstChild;null!=node;node=node.nextSibling)if(node.nodeType==document.COMMENT_NODE){var match=(node.data||"").match(/Information:([\s\S]*)/im);match&&(text=match[1]||null);break}if(text||(text="No widget information available"),text&&(text=text.replace(/\n\n/g,"<br/>").replace(/\n/g," ").replace(/<br\/>/g,"\n\n")),window.parent!=window){var entry={type:"showinfobox",text:text};window.parent.postMessage(JSON.stringify(entry),"*")}},KoopidWidget.prototype.onload=function(){var zoom=this.getParam("zoom");if(zoom)console.log("koopid-widget.js: applying zoom="+zoom+" (from param) to body"),document.body.style.zoom=zoom;else{var minwidth=this.getParam("min-width")||document.body.getAttribute("min-width")||null,minheight=this.getParam("min-height")||document.body.getAttribute("min-height")||null;minwidth&&minheight&&setTimeout(function(){if(minwidth=parseInt(minwidth),minheight=parseInt(minheight),window.screen&&window.screen.availWidth&&window.innerWidth==window.screen.availWidth&&(window.innerWidth<minwidth||window.innerHeight<minheight)){var zoom=Math.min(window.innerWidth/minwidth,window.innerHeight/minheight);console.log("koopid-widget.js: applying zoom="+zoom+" (from min size) to body"),document.body.style.zoom=""+zoom}},100)}};var kpdw=new KoopidWidget;